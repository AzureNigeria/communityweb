{{ $now := now }}
{{ $events := where (where .Site.RegularPages "Section" "events") "Params.status" "upcoming" }}
{{ $events = where $events "Date" "ge" $now }}
{{ $seriesSessions := where (where .Site.RegularPages "Section" "series") "Params.layout" "series-session" }}
{{ $seriesSessions = where $seriesSessions "Date" "ge" $now }}
{{ $candidates := slice }}
{{ range $events }}
  {{ $candidates = $candidates | append . }}
{{ end }}
{{ range $seriesSessions }}
  {{ $candidates = $candidates | append . }}
{{ end }}
{{ $next := false }}
{{ if gt (len $candidates) 0 }}
  {{ $next = index (sort $candidates "Date") 0 }}
{{ end }}
<div class="countdown-card upcoming-card" id="upcoming-session">
  <div class="countdown-header">
    <div class="countdown-kicker">
      <span class="live-badge" hidden>Live Now</span>
      <p class="status">Upcoming Live Session</p>
    </div>
  </div>
  <div class="countdown-info">
    {{ if $next }}
      {{ $isSeriesSession := and (eq $next.Section "series") (eq $next.Params.layout "series-session") }}
      {{ $topic := $next.Title }}
      {{ $subtopic := "" }}
      {{ if $isSeriesSession }}
        {{ with $next.Parent }}
          {{ $topic = .Title }}
          {{ $subtopic = $next.Title }}
        {{ else }}
          {{ $subtopic = $next.Title }}
        {{ end }}
      {{ else }}
        {{ $titleParts := split $next.Title ":" }}
        {{ if gt (len $titleParts) 1 }}
          {{ $topic = index $titleParts 0 | strings.TrimSpace }}
          {{ $subtopic = delimit (after 1 $titleParts) ":" | strings.TrimSpace }}
        {{ else if $next.Params.subtitle }}
          {{ $subtopic = $next.Params.subtitle }}
        {{ else if $next.Params.description }}
          {{ $subtopic = $next.Params.description }}
        {{ end }}
      {{ end }}
      <h3 class="upcoming-title">
        <span class="upcoming-topic">{{ $topic }}</span>
        {{ if $subtopic }}
          <span class="upcoming-subtopic">{{ $subtopic }}</span>
        {{ end }}
      </h3>
    {{ else }}
      <h3 class="upcoming-title">
        <span class="upcoming-topic">Next Session Announcing Soon</span>
        <span class="upcoming-subtopic">Stay tuned for our upcoming Azure deep dive.</span>
      </h3>
    {{ end }}
  </div>
  <div class="countdown-body">
    {{ if $next }}
      <div class="countdown" data-countdown="{{ $next.Date.Format "2006-01-02T15:04:05Z07:00" }}">
        <div class="time-block">
          <span class="number" data-days>00</span>
          <span class="label">Days</span>
        </div>
        <div class="time-block">
          <span class="number" data-hours>00</span>
          <span class="label">Hours</span>
        </div>
        <div class="time-block">
          <span class="number" data-minutes>00</span>
          <span class="label">Minutes</span>
        </div>
        <div class="time-block">
          <span class="number" data-seconds>00</span>
          <span class="label">Seconds</span>
        </div>
      </div>
      <div class="countdown-meta">
        <div class="upcoming-meta">
          <span>Starts {{ $next.Date.Format "Jan 02, 2006 | 3:04 PM" }} WAT</span>
          {{ with $next.Params.speaker }}
            <span class="upcoming-speaker">{{ . }}{{ with $next.Params.speaker_title }} <span class="speaker-title">- {{ . }}</span>{{ end }}</span>
          {{ end }}
        </div>
        <div class="countdown-actions">
          {{ $ctaLink := $next.RelPermalink }}
          {{ $ctaLabel := "View Details" }}
          {{ with $next.Params.registration_url }}
            {{ $ctaLink = . }}
            {{ $ctaLabel = "Register" }}
          {{ end }}
          {{ $isExternal := hasPrefix $ctaLink "http" }}
          <a class="btn-secondary btn-small" href="{{ $ctaLink }}"{{ if $isExternal }} target="_blank" rel="noreferrer"{{ end }}>{{ $ctaLabel }}</a>
        </div>
      </div>
    {{ else }}
      <div class="countdown countdown-empty">
        <div class="time-block">
          <span class="number">00</span>
          <span class="label">Days</span>
        </div>
        <div class="time-block">
          <span class="number">00</span>
          <span class="label">Hours</span>
        </div>
        <div class="time-block">
          <span class="number">00</span>
          <span class="label">Minutes</span>
        </div>
        <div class="time-block">
          <span class="number">00</span>
          <span class="label">Seconds</span>
        </div>
      </div>
      <div class="countdown-meta">
        <div class="upcoming-meta">
          <span>Next date TBD</span>
        </div>
        <div class="countdown-actions">
          <a class="btn-secondary btn-small" href="{{ "/events" | relURL }}">View Events</a>
        </div>
      </div>
    {{ end }}
  </div>
</div>
