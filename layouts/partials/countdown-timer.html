{{ $now := now }}
{{ $nowUnix := $now.Unix }}
{{ $eventMax := 18000 }}
{{ $seriesMax := 10800 }}
{{ $schedule := slice }}
{{ $events := where .Site.RegularPages "Section" "events" }}
{{ range $events }}
  {{ $startUnix := .Date.Unix }}
  {{ $endUnix := add $startUnix $eventMax }}
  {{ with .Params.end_date }}
    {{ $candidate := (time .).Unix }}
    {{ if lt $candidate $endUnix }}
      {{ $endUnix = $candidate }}
    {{ end }}
  {{ end }}
  {{ $topic := .Title }}
  {{ $subtopic := "" }}
  {{ $titleParts := split .Title ":" }}
  {{ if gt (len $titleParts) 1 }}
    {{ $topic = index $titleParts 0 | strings.TrimSpace }}
    {{ $subtopic = delimit (after 1 $titleParts) ":" | strings.TrimSpace }}
  {{ else if .Params.subtitle }}
    {{ $subtopic = .Params.subtitle }}
  {{ else if .Params.description }}
    {{ $subtopic = .Params.description }}
  {{ end }}
  {{ $ctaLink := .RelPermalink }}
  {{ $ctaLabel := "View Details" }}
  {{ with .Params.registration_url }}
    {{ $ctaLink = . }}
    {{ $ctaLabel = "Register" }}
  {{ end }}
  {{ $schedule = $schedule | append (dict "start" $startUnix "end" $endUnix "startISO" (.Date.Format "2006-01-02T15:04:05Z07:00") "startLabel" (.Date.Format "Jan 02, 2006 | 3:04 PM") "topic" $topic "subtopic" $subtopic "speaker" .Params.speaker "speakerTitle" .Params.speaker_title "ctaLink" $ctaLink "ctaLabel" $ctaLabel "ctaExternal" (hasPrefix $ctaLink "http")) }}
{{ end }}
{{ $seriesSessions := where (where .Site.RegularPages "Section" "series") "Params.layout" "series-session" }}
{{ range $seriesSessions }}
  {{ $session := . }}
  {{ $startUnix := .Date.Unix }}
  {{ $endUnix := add $startUnix $seriesMax }}
  {{ with .Params.end_date }}
    {{ $candidate := (time .).Unix }}
    {{ if lt $candidate $endUnix }}
      {{ $endUnix = $candidate }}
    {{ end }}
  {{ end }}
  {{ $topic := .Title }}
  {{ $subtopic := "" }}
  {{ with .Parent }}
    {{ $topic = .Title }}
    {{ $subtopic = $session.Title }}
  {{ else }}
    {{ $subtopic = .Title }}
  {{ end }}
  {{ $ctaLink := .RelPermalink }}
  {{ $ctaLabel := "View Details" }}
  {{ with .Params.registration_url }}
    {{ $ctaLink = . }}
    {{ $ctaLabel = "Register" }}
  {{ end }}
  {{ $schedule = $schedule | append (dict "start" $startUnix "end" $endUnix "startISO" (.Date.Format "2006-01-02T15:04:05Z07:00") "startLabel" (.Date.Format "Jan 02, 2006 | 3:04 PM") "topic" $topic "subtopic" $subtopic "speaker" .Params.speaker "speakerTitle" .Params.speaker_title "ctaLink" $ctaLink "ctaLabel" $ctaLabel "ctaExternal" (hasPrefix $ctaLink "http")) }}
{{ end }}
{{ $live := slice }}
{{ $upcoming := slice }}
{{ range $schedule }}
  {{ $start := index . "start" }}
  {{ $end := index . "end" }}
  {{ if and (ge $nowUnix $start) (lt $nowUnix $end) }}
    {{ $live = $live | append . }}
  {{ else if lt $nowUnix $start }}
    {{ $upcoming = $upcoming | append . }}
  {{ end }}
{{ end }}
{{ $next := false }}
{{ if gt (len $live) 0 }}
  {{ $next = index (sort $live "start") 0 }}
{{ else if gt (len $upcoming) 0 }}
  {{ $next = index (sort $upcoming "start") 0 }}
{{ end }}
{{ $scheduleJson := $schedule | jsonify }}
<div class="countdown-card upcoming-card" id="upcoming-session" data-schedule='{{ $scheduleJson | safeHTMLAttr }}'>
  <div class="countdown-header">
    <div class="countdown-kicker">
      <span class="live-badge" hidden>Live Now</span>
      <p class="status">Upcoming Live Session</p>
    </div>
  </div>
  <div class="countdown-info">
    {{ if $next }}
      {{ $topic := index $next "topic" }}
      {{ $subtopic := index $next "subtopic" }}
      <h3 class="upcoming-title">
        <span class="upcoming-topic" data-upcoming-topic>{{ $topic }}</span>
        <span class="upcoming-subtopic {{ if not $subtopic }}hidden{{ end }}" data-upcoming-subtopic>{{ $subtopic }}</span>
      </h3>
    {{ else }}
      <h3 class="upcoming-title">
        <span class="upcoming-topic">Next Session Announcing Soon</span>
        <span class="upcoming-subtopic">Stay tuned for our upcoming Azure deep dive.</span>
      </h3>
    {{ end }}
  </div>
  <div class="countdown-body">
    {{ if $next }}
      <div class="countdown" data-countdown="{{ index $next "startISO" }}" data-end="{{ index $next "end" }}">
        <div class="time-block">
          <span class="number" data-days>00</span>
          <span class="label">Days</span>
        </div>
        <div class="time-block">
          <span class="number" data-hours>00</span>
          <span class="label">Hours</span>
        </div>
        <div class="time-block">
          <span class="number" data-minutes>00</span>
          <span class="label">Minutes</span>
        </div>
        <div class="time-block">
          <span class="number" data-seconds>00</span>
          <span class="label">Seconds</span>
        </div>
      </div>
      <div class="countdown-meta">
        <div class="upcoming-meta">
          <span>Starts <span data-upcoming-start>{{ index $next "startLabel" }}</span> WAT</span>
          <span class="upcoming-speaker {{ if not (index $next "speaker") }}hidden{{ end }}">
            <span data-upcoming-speaker-name>{{ index $next "speaker" | default "" }}</span>
            <span class="speaker-title {{ if not (index $next "speakerTitle") }}hidden{{ end }}" data-upcoming-speaker-title>{{ with (index $next "speakerTitle") }}- {{ . }}{{ end }}</span>
          </span>
        </div>
        <div class="countdown-actions">
          {{ $ctaLink := index $next "ctaLink" }}
          {{ $ctaLabel := index $next "ctaLabel" }}
          {{ $isExternal := index $next "ctaExternal" }}
          <a class="btn-secondary btn-small" data-upcoming-cta href="{{ $ctaLink }}"{{ if $isExternal }} target="_blank" rel="noreferrer"{{ end }}>{{ $ctaLabel }}</a>
        </div>
      </div>
    {{ else }}
      <div class="countdown countdown-empty">
        <div class="time-block">
          <span class="number">00</span>
          <span class="label">Days</span>
        </div>
        <div class="time-block">
          <span class="number">00</span>
          <span class="label">Hours</span>
        </div>
        <div class="time-block">
          <span class="number">00</span>
          <span class="label">Minutes</span>
        </div>
        <div class="time-block">
          <span class="number">00</span>
          <span class="label">Seconds</span>
        </div>
      </div>
      <div class="countdown-meta">
        <div class="upcoming-meta">
          <span>Next date TBD</span>
        </div>
        <div class="countdown-actions">
          <a class="btn-secondary btn-small" href="{{ "/events" | relURL }}">View Events</a>
        </div>
      </div>
    {{ end }}
  </div>
</div>
