{{ define "main" }}
  {{ $series := .Parent }}
  {{ $startDate := .Date }}
  {{ $startUnix := $startDate.Unix }}
  {{ $endDate := $startDate.Add (duration "h" 3) }}
  {{ with .Params.end_date }}
    {{ $candidate := time . }}
    {{ if lt $candidate.Unix $endDate.Unix }}
      {{ $endDate = $candidate }}
    {{ end }}
  {{ end }}
  {{ $endUnix := $endDate.Unix }}
  {{ $startISO := $startDate.Format "2006-01-02T15:04:05-07:00" }}
  {{ $endISO := $endDate.Format "2006-01-02T15:04:05-07:00" }}
  {{ $nowUnix := now.Unix }}
  {{ $status := "completed" }}
  {{ if lt $nowUnix $startUnix }}
    {{ $status = "upcoming" }}
  {{ else if lt $nowUnix $endUnix }}
    {{ $status = "ongoing" }}
  {{ end }}
  <section class="page-hero">
    <div class="container">
      <p class="breadcrumb">
        <a href="{{ "/" | relURL }}">Home</a> /
        <a href="{{ "/series" | relURL }}">Study Series</a>
        {{ if $series }} / <a href="{{ $series.RelPermalink }}">{{ $series.Title }}</a>{{ end }}
      </p>
      <h1>{{ .Title }}</h1>
      <div class="hero-badges">
        <span class="badge"><img src="{{ "images/icons/calendar.svg" | relURL }}" alt="Date icon" />{{ .Date.Format "Jan 02, 2006" }}</span>
        <span class="badge"><img src="{{ "images/icons/clock.svg" | relURL }}" alt="Time icon" />{{ .Date.Format "3:04 PM" }}</span>
        {{ with .Params.location }}
          <span class="badge"><img src="{{ "images/icons/map-pin.svg" | relURL }}" alt="Location icon" />{{ . }}</span>
        {{ end }}
      </div>
    </div>
  </section>
  <section class="section">
    <div class="container two-column">
      <article class="content">
        {{ if .Params.description }}
          <p class="lead">{{ .Params.description }}</p>
        {{ end }}
        {{ .Content }}
      </article>
      <aside class="sidebar">
        {{ if eq $status "completed" }}
          {{ $recordingLink := .Site.Data.social.youtube.url }}
          {{ with .Params.recording_url }}
            {{ $recordingLink = . }}
          {{ end }}
          <a class="btn-primary" href="{{ $recordingLink }}" target="_blank" rel="noreferrer">Watch Recording</a>
          {{ $contentLink := "" }}
          {{ if .Params.content_url }}
            {{ $contentLink = .Params.content_url }}
          {{ else if .Params.slides_url }}
            {{ $contentLink = .Params.slides_url }}
          {{ else if .Params.github_url }}
            {{ $contentLink = .Params.github_url }}
          {{ end }}
          {{ if $contentLink }}
            <a class="btn-secondary btn-small" href="{{ $contentLink }}" target="_blank" rel="noreferrer">Session Content</a>
          {{ else }}
            <button class="btn-secondary btn-small" type="button" disabled>Session Content</button>
          {{ end }}
        {{ else }}
          {{ with .Params.registration_url }}
            <a class="btn-primary" href="{{ . }}" target="_blank" rel="noreferrer">Register</a>
          {{ else }}
            <button class="btn-primary" type="button" disabled>Registration Closed</button>
          {{ end }}
        {{ end }}
        <div class="card speaker-card">
          <img src="{{ .Params.speaker_image | relURL }}" alt="{{ .Params.speaker }}" loading="lazy" decoding="async" />
          <h4>{{ .Params.speaker }}</h4>
          <p class="muted">{{ .Params.speaker_title }}</p>
          <p>{{ .Params.speaker_bio }}</p>
          {{ with .Params.speaker_linkedin }}
            <a class="btn-secondary btn-small" href="{{ . }}" target="_blank" rel="noreferrer">LinkedIn</a>
          {{ end }}
        </div>
        {{ if and (ne $status "completed") (.Params.recording_url) }}
          <div class="card">
            <h4>Recording</h4>
            <a class="btn-secondary btn-small" href="{{ .Params.recording_url }}" target="_blank" rel="noreferrer">Watch Recording</a>
          </div>
        {{ end }}
        <div class="card">
          <h4>Share</h4>
          {{ $shareText := .Params.description | default (.Summary | plainify) | default .Site.Params.description | plainify | truncate 160 }}
          <button class="btn-secondary share-btn" type="button" data-share data-share-title="{{ .Title }}" data-share-text="{{ $shareText }}" data-share-url="{{ .Permalink }}">
            <img src="{{ "images/icons/share.svg" | relURL }}" alt="Share icon" />Share Session
          </button>
        </div>
        {{ if $endISO }}
          {{ $start := $startDate.Format "20060102T150405Z" }}
          {{ $end := $endDate.Format "20060102T150405Z" }}
          {{ $youtubeLink := "" }}
          {{ with .Site.Data.social.youtube.url }}
            {{ $youtubeLink = . }}
          {{ end }}
          {{ $details := .Params.description | default .Summary }}
          {{ if $youtubeLink }}
            {{ $details = printf "%s\n\nWatch live: %s" $details $youtubeLink }}
          {{ end }}
          {{ $details = printf "%s\n\nReminder: 30 minutes before start." $details }}
          {{ $icsDetails := replace $details "\n" "\\n" }}
          {{ $location := .Params.location | default "Virtual" }}
          {{ $detailsQuery := replace ($details | urlquery) "+" "%20" }}
          {{ $locationQuery := replace ($location | urlquery) "+" "%20" }}
          {{ $gcal := printf "https://calendar.google.com/calendar/render?action=TEMPLATE&text=%s&dates=%s/%s&details=%s&location=%s" (.Title | urlquery) $start $end $detailsQuery $locationQuery }}
          {{ $ics := printf "BEGIN:VCALENDAR\nVERSION:2.0\nBEGIN:VEVENT\nSUMMARY:%s\nDTSTART:%s\nDTEND:%s\nDESCRIPTION:%s\nLOCATION:%s\nBEGIN:VALARM\nTRIGGER:-PT30M\nACTION:DISPLAY\nDESCRIPTION:Reminder\nEND:VALARM\nEND:VEVENT\nEND:VCALENDAR" .Title $start $end $icsDetails $location }}
          {{ $icsEncoded := replace ($ics | urlquery) "+" "%20" }}
          <div class="card">
            <h4>Add to Calendar</h4>
            <div class="icon-row">
              <a class="icon-btn" href="{{ $gcal }}" target="_blank" rel="noreferrer"><img src="{{ "images/icons/calendar.svg" | relURL }}" alt="Calendar icon" />Google</a>
              <a class="icon-btn" href="data:text/calendar;charset=utf-8,{{ $icsEncoded }}" download="{{ .File.BaseFileName }}.ics"><img src="{{ "images/icons/calendar.svg" | relURL }}" alt="Calendar icon" />iCal</a>
            </div>
          </div>
        {{ end }}
      </aside>
    </div>
  </section>
  {{ partial "explore-more.html" . }}
{{ end }}
